<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Buddy - Find Your Room</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
       
        :root {
            
            --primary-dark: #333;
            --primary-orange: #f56e14;
            --text-light: white;
            --text-dark: #333;
            --bg-light: #f9f9f9;
            --card-bg: #ffffff;
            --border-color: #ddd;
            --card-shadow: rgba(0, 0, 0, 0.1);
            --primary-green: #4CAF50;
            --offer-badge-bg: #ef5350;
            --secondary-gray: #ecf0f1;
        }


        .home_header {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        
        .book_container {
            max-width: 1200px;
            width: 95%; 
            margin: 20px auto;
            padding: 20px 0;
            display: flex;
            gap: 30px;
            flex-grow: 1;
        }

        .filters_sidebar {
            flex: 0 0 280px; 
            padding: 20px;
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 2px 5px var(--card-shadow);
        }
        
        .filter_group {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        .filter_options label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9em;
            cursor: pointer;
        }

   
        #hotel-search {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-sizing: border-box;
        }

        .hotel_listings {
            flex-grow: 1;
        }
        
        .hotel_listings h2 {
            margin-top: 0;
            color: var(--primary-dark);
            border-bottom: 2px solid var(--primary-orange);
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

     
        .hotel_card_grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .hotel_card {
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        .hotel_card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
        }
        .card_image {
            height: 200px;
            overflow: hidden;
        }
        .card_image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .card_info {
            padding: 15px;
        }
        .card_title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .card_title h4 {
            margin: 0;
            font-size: 1.2em;
            color: var(--primary-dark);
        }
        .card_rating {
            color: #ffc107;
        }
        .card_price_offer {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .card_price {
            font-size: 1.4em;
            font-weight: bold;
            color: var(--primary-orange);
        }
        .card_offer {
            font-size: 0.9em;
            color: var(--offer-badge-bg);
            font-weight: 600;
        }
        .no-results {
            text-align: center;
            padding: 40px;
            color: #777;
            font-size: 1.1em;
            background: var(--card-bg);
            border-radius: 8px;
            margin-top: 20px;
        }
        .no-results i {
            margin-right: 10px;
            color: var(--offer-badge-bg);
        }

        .modal {
            display: none;
            position: fixed; 
            z-index: 1000; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.4); 
            padding-top: 60px;
        }

        .modal-content {
            background-color: var(--bg-light);
            margin: 5% auto; 
            padding: 30px;
            border: 1px solid #888;
            width: 90%; 
            max-width: 1200px; 
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
            animation: zoomIn 0.3s;
        }
        @keyframes zoomIn {
            from {transform: scale(0.9); opacity: 0;}
            to {transform: scale(1); opacity: 1;}
        }

        .close-btn {
            color: var(--primary-dark);
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            top: 10px;
            right: 20px;
        }

        .modal-header h2 {
            color: var(--primary-orange);
            margin-top: 0;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-rating {
            color: #ffc107;
            font-size: 1.2em;
        }

        .modal-main-img {
            width: 100%;
            max-height: 350px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .modal-details-grid {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .detail-box {
            flex: 1;
            min-width: 250px;
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            text-align: center;
            background-color: var(--card-bg);
        }
        .detail-box.full-width {
            flex-basis: 100%;
            text-align: left;
        }
        .detail-box .big-number {
            font-size: 2em;
            font-weight: bold;
            color: var(--primary-orange);
            margin: 5px 0;
        }
        .detail-box .small-text {
            font-size: 0.8em;
            color: #777;
        }

        .modal-facilities-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
            margin-bottom: 20px;
        }
        .modal-facility-item {
            background-color: var(--secondary-gray);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            color: var(--text-dark);
        }
        .modal-facility-item i {
            color: var(--primary-green);
            margin-right: 5px;
        }

        .modal-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }
        .modal-price .price-big {
            font-size: 2em;
            color: var(--offer-badge-bg);
            font-weight: bold;
            margin-left: 10px;
        }
        .modal-price .offer-text {
             font-size: 0.9em;
             color: var(--primary-green);
        }

        .modal-book-btn {
            background-color: var(--primary-orange);
            color: var(--text-light);
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .modal-book-btn:hover {
            background-color: #d85c0f;
        }

        
        @media (max-width: 768px) {
            .book_container {
                flex-direction: column;
            }
            .filters_sidebar {
                flex: 0 0 auto;
            }
            .modal-content {
                width: 95%;
                margin: 10% auto;
                padding: 20px;
            }
            .modal-details-grid {
                flex-direction: column;
            }
            .detail-box {
                min-width: 100%;
            }
            .modal-footer {
                flex-direction: column;
                gap: 15px;
            }
        }
        
.notification {
  position: fixed;
  top: 20px;
  right: 20px;
  padding: 15px 20px;
  border-radius: 5px;
  color: white;
  z-index: 10000;
  animation: slideIn 0.3s ease-out;
}

.notification.success { background-color: #4CAF50; }
.notification.error { background-color: #f44336; }
.notification.info { background-color: #2196F3; }

@keyframes slideIn {
  from { transform: translateX(100%); }
  to { transform: translateX(0); }
}

.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.4);
}

.modal-content {
  background-color: #fefefe;
  margin: 15% auto;
  padding: 20px;
  border: 1px solid #888;
  width: 80%;
  max-width: 500px;
  border-radius: 10px;
}

.close {
  color: #aaa;
  float: right;
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
}

.close:hover { color: #000; }

.booking-card {
  border: 1px solid #ddd;
  padding: 15px;
  margin: 10px 0;
  border-radius: 5px;
  background-color: #f9f9f9;
}

.food-item {
  border: 1px solid #eee;
  padding: 10px;
  margin: 5px 0;
  border-radius: 5px;
}

.quantity-controls {
  display: inline-block;
  margin-left: 10px;
}

.quantity-controls button {
  width: 30px;
  height: 30px;
  border: 1px solid #ddd;
  background-color: #f5f5f5;
  cursor: pointer;
}

.quantity-controls span {
  display: inline-block;
  width: 30px;
  text-align: center;
  margin: 0 5px;
}

    </style>
</head>
<body>
    <header class="home_head">
        <div class="home_header">
            <div class="home_heading">
                <h1>Book <span class="buddy">Buddy</span></h1>
            </div>
            <div class="home_links">
                <nav class="home_nav">
                    <a href="index.html">Home</a>
                    <a href="room.html">Rooms</a>
                    <a href="login.html" id="signin-btn" class="btn">Sign in</a>
                    <a href="#" id="delete-account-btn" class="btn" style="display:none;background:#c0392b;">Delete Account</a>
                </nav>
            </div>
        </div>
    </header>
    <script>
    
      (function(){
        try {
          const u = JSON.parse(localStorage.getItem('user') || 'null');
          const role = (u && u.role ? String(u.role) : 'Customer').toLowerCase();
          if (role === 'manager') { window.location.href = 'manage.html'; return; }
          if (role === 'staff' || role === 'employee') { window.location.href = 'staff.html'; return; }
        } catch(_) {}
      })();
    </script>
    <hr class="header-hr">

    <main class="book_container">
        <aside class="filters_sidebar">
            <h3>Filter Facilities</h3>

            <div class="filter_group">
                <h4>Search Hotel Name <i class="fas fa-hotel"></i></h4>
                <input type="text" id="hotel-search" placeholder="e.g., Taj or Leela" 
                       oninput="updateFilters()">
            </div>

            <div class="filter_group">
                <h4>Your Location <i class="fas fa-location-dot"></i></h4>
                <button onclick="getUserLocation()" id="location-btn" 
                        style="background: var(--primary-orange); color: white; padding: 10px; border: none; border-radius: 5px; width: 100%; cursor: pointer; margin-bottom: 10px;">
                    <i class="fas fa-crosshairs"></i> Get My Location
                </button>
                <div class="price-range-display" id="location-display" style="font-size: 0.9em; color: #666; text-align: center;">Location not set.</div>
                <div class="filter_options" id="proximity-filter" style="margin-top: 10px; display: none;">
                    <label><input type="checkbox" class="facility-checkbox" value="nearby" onchange="updateFilters()"> Show Nearby Hotels Only</label>
                </div>
            </div>
            
            <div class="filter_group">
                <h4>Price Range üí∞</h4>
                <input type="range" id="price-slider" min="1000" max="25000" value="25000" step="1000" oninput="updateFilters()">
                <div class="price-range-display">Max: <span id="max-price">‚Çπ25,000</span></div>
            </div>

            <div class="filter_group">
                <h4>Rating <i class="fas fa-star" style="color:#ffc107;"></i></h4>
                <div class="filter_options">
                    <label><input type="checkbox" class="rating-checkbox" value="5" onchange="updateFilters()"> 5 Stars</label>
                    <label><input type="checkbox" class="rating-checkbox" value="4" onchange="updateFilters()"> 4+ Stars</label>
                    <label><input type="checkbox" class="rating-checkbox" value="3" onchange="updateFilters()"> 3+ Stars</label>
                </div>
            </div>

            <div class="filter_group">
                <h4>Room Type <i class="fas fa-thermometer-half"></i></h4>
                <div class="filter_options">
                    <label><input type="checkbox" class="facility-checkbox" value="acRooms" onchange="updateFilters()"> AC Rooms Available</label>
                    <label><input type="checkbox" class="facility-checkbox" value="nonAcRooms" onchange="updateFilters()"> Non-AC Rooms Available</label>
                </div>
            </div>

            <div class="filter_group">
                <h4>Food & Dining <i class="fas fa-utensils"></i></h4>
                <div class="filter_options">
                    <label><input type="checkbox" class="facility-checkbox" value="breakfast" onchange="updateFilters()"> Breakfast Included</label>
                    <label><input type="checkbox" class="facility-checkbox" value="lunch" onchange="updateFilters()"> Lunch Included</label>
                    <label><input type="checkbox" class="facility-checkbox" value="dinner" onchange="updateFilters()"> Dinner Included</label>
                    <label><input type="checkbox" class="facility-checkbox" value="veg" onchange="updateFilters()"> Vegetarian Only</label>
                    <label><input type="checkbox" class="facility-checkbox" value="nonVeg" onchange="updateFilters()"> Non-Vegetarian Available</label>
                    <label><input type="checkbox" class="facility-checkbox" value="both" onchange="updateFilters()"> Both Veg & Non-Veg</label>
                    <label><input type="checkbox" class="facility-checkbox" value="barLounge" onchange="updateFilters()"> Bar/Lounge</label>
                </div>
            </div>

            <div class="filter_group">
                <h4>Other Amenities <i class="fas fa-concierge-bell"></i></h4>
                <div class="filter_options">
                    <label><input type="checkbox" class="facility-checkbox" value="suite" onchange="updateFilters()"> Suite Rooms</label>
                    <label><input type="checkbox" class="facility-checkbox" value="swimmingPool" onchange="updateFilters()"> Swimming Pool</label>
                    <label><input type="checkbox" class="facility-checkbox" value="sunView" onchange="updateFilters()"> Sun View</label>
                    <label><input type="checkbox" class="facility-checkbox" value="laundry" onchange="updateFilters()"> Laundry Service</label>
                    <label><input type="checkbox" class="facility-checkbox" value="gym" onchange="updateFilters()"> Gym/Fitness</label>
                    <label><input type="checkbox" class="facility-checkbox" value="spa" onchange="updateFilters()"> Spa / Wellness</label>
                    <label><input type="checkbox" class="facility-checkbox" value="resort" onchange="updateFilters()"> Resort Property</label>
                    <label><input type="checkbox" class="facility-checkbox" value="cityCenter" onchange="updateFilters()"> City Center</label>
                    <label><input type="checkbox" class="facility-checkbox" value="beachFront" onchange="updateFilters()"> Beach Front</label>
                    <label><input type="checkbox" class="facility-checkbox" value="petFriendly" onchange="updateFilters()"> Pet Friendly</label>
                </div>
            </div>
            
            <button onclick="clearFilters()" style="background: var(--primary-dark); color: var(--text-light); padding: 10px; border: none; border-radius: 5px; width: 100%; cursor: pointer;">Clear Filters</button>

        </aside>

        <section class="hotel_listings">
            <h2>Hotels Matching Your Search</h2>
            
            <p id="no-results" class="no-results" style="display:none;">
                <i class="fas fa-exclamation-circle"></i> No hotels found matching your current filter criteria.
            </p>

            <div class="hotel_card_grid" id="hotel-card-grid">
                </div>
        </section>
    </main>

    <div id="hotel-detail-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <div id="modal-details-container">
                </div>
        </div>
    </div>
    <script>
     
      (function(){
        function hasToken(){ try { return !!(localStorage.getItem('token')||localStorage.getItem('authToken')||localStorage.getItem('jwt')); } catch { return false; } }
        function baseURL(){ return (typeof window!=='undefined' && window.location && window.location.origin) ? `${window.location.origin}/api/v1` : 'http://localhost:5002/api/v1'; }
        const delBtn = document.getElementById('delete-account-btn');
        const signIn = document.getElementById('signin-btn');
        if (delBtn){
          const loggedIn = hasToken();
          delBtn.style.display = loggedIn ? 'inline-block' : 'none';
          if (signIn) signIn.style.display = loggedIn ? 'none' : 'inline-block';
          delBtn.addEventListener('click', async (e)=>{
            e.preventDefault();
            if (!confirm('Delete your account? This action cannot be undone.')) return;
            try {
              if (window.api && typeof window.api.request === 'function'){
                await window.api.request('/auth/delete-account', { method: 'DELETE' });
              } else {
                const t = localStorage.getItem('token')||localStorage.getItem('authToken')||localStorage.getItem('jwt')||'';
                await fetch(baseURL() + '/auth/delete-account', { method:'DELETE', headers:{ 'Content-Type':'application/json', ...(t?{Authorization:`Bearer ${t}`}:{}) } });
              }
              try { localStorage.removeItem('token'); localStorage.removeItem('authToken'); localStorage.removeItem('jwt'); } catch {}
              alert('Your account has been deleted.');
              window.location.href = 'index.html';
            } catch (err) {
              alert('Failed to delete account: ' + (err && err.message ? err.message : 'Unknown error'));
            }
          });
        }
      })();
    </script>
    <script>
      
      (function(){
        const modal = document.getElementById('hotel-detail-modal');
        const container = document.getElementById('modal-details-container');
        window.closeModal = function(){ if (modal) modal.style.display = 'none'; };
        window.openHotelModal = function(h){
          if (!modal || !container) return;
          window.__modalHotel = h;
          const fallback = 'images/hotel-placeholder.svg';
          const imgUrl = h.image_url || h.image || fallback;
          container.innerHTML = `
            <div class="modal-header"><h2>${h.name || 'Hotel'}</h2></div>
            <img class="modal-main-img" src="${imgUrl}" onerror="this.onerror=null;this.src='images/hotel-placeholder.svg';" alt="${h.name || 'Hotel'}">
            <div class="detail-box full-width">
              <i class="fas fa-location-dot" style="color:#f56e14"></i>
              <span style="margin-left:8px;">${h.address || h.location || 'Location not available'}</span>
            </div>
            <div class="detail-box full-width" id="room-select-box">
              <label for="room-select" style="font-weight:600;display:block;margin-bottom:6px;">Select Available Room</label>
              <select id="room-select" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;">
                <option value="">Loading rooms...</option>
              </select>
              <div id="room-select-hint" style="margin-top:6px;color:#777;font-size:0.9em;">Only Vacant rooms are listed.</div>
            </div>
            <div class="modal-facilities-grid">
              ${(h.facilities || []).map(f => `<span class="modal-facility-item"><i class="fas fa-check-circle"></i> ${f}</span>`).join('') || '<span class="modal-facility-item">Standard Facilities</span>'}
            </div>
            <div class="modal-footer">
              <div class="modal-price">From <span class="price-big">‚Çπ${Number(h.base_price_per_night||h.price||0).toLocaleString('en-IN')}</span></div>
              <button class="modal-book-btn" onclick="bookNowFromModal()">Book Now</button>
            </div>
          `;
          modal.style.display = 'block';
         
          try{
            (async () => {
              const resp = await api.request(`/bookings/available-rooms?hotel_id=${encodeURIComponent(h.hotel_id||h.id)}&t=${Date.now()}`);
              const list = Array.isArray(resp?.data) ? resp.data : (Array.isArray(resp) ? resp : []);
              const sel = document.getElementById('room-select');
              if (!sel) return;
              if (!list.length){
                sel.innerHTML = '<option value="">No rooms available</option>';
                sel.disabled = true;
              } else {
                sel.innerHTML = '<option value="">Select a room</option>' + list.map(r => `<option value="${r.room_number}">${r.room_number}</option>`).join('');
                sel.disabled = false;
              }
            })();
          }catch(e){
            const sel = document.getElementById('room-select');
            if (sel){ sel.innerHTML = '<option value="">Unable to load rooms</option>'; sel.disabled = true; }
          }
        };
        window.bookNowFromModal = function(){
          try{
            const h = window.__modalHotel || {};
            const bookingDetails = {
              id: h.hotel_id || h.id,
              name: h.name,
              lowestRate: Number(h.base_price_per_night || h.price || 0)
            };
            sessionStorage.setItem('selectedHotel', JSON.stringify(bookingDetails));
          
            const sel = document.getElementById('room-select');
            const roomNo = sel && sel.value ? String(sel.value) : '';
            if (roomNo) sessionStorage.setItem('selectedRoomNumber', roomNo);
            window.location.href = 'room.html';
          }catch(e){ console.error(e); }
        };
        document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') closeModal(); });
        window.addEventListener('click', (e)=>{ if (e.target === modal) closeModal(); });
      })();
    </script>
    <hr class="footer-hr">
    <footer>
        <div>&copy; 2025 BookBuddy</div>
    </footer>

    <script>

        const hotelSearchInput = document.getElementById('hotel-search');
        const priceSlider = document.getElementById('price-slider');
        const maxPriceDisplay = document.getElementById('max-price');
        const cardGrid = document.getElementById('hotel-card-grid');
        const noResultsMessage = document.getElementById('no-results');
        const proximityFilter = document.getElementById('proximity-filter');
        const locationDisplay = document.getElementById('location-display');
        const NEARBY_RADIUS_KM = 10;
        let userLocation = null;

        function getDistanceFromLatLonInKm(lat1,lon1,lat2,lon2){
            function deg2rad(deg){ return deg * (Math.PI/180); }
            const R = 6371; // km
            const dLat = deg2rad(lat2-lat1);
            const dLon = deg2rad(lon2-lon1);
            const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(deg2rad(lat1))*Math.cos(deg2rad(lat2))*Math.sin(dLon/2)*Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function renderHotelsGrid(list){
            if (!cardGrid) return;
            const hotels = Array.isArray(list) ? list : hotelData;
            if (!hotels.length){
                cardGrid.innerHTML = '';
                if (noResultsMessage) noResultsMessage.style.display = 'block';
                return;
            }
            if (noResultsMessage) noResultsMessage.style.display = 'none';
            cardGrid.innerHTML = '';
            hotels.forEach(h => cardGrid.appendChild(createHotelCard(h)));
        }

        function updateFilters(){
            const term = (hotelSearchInput?.value || '').trim().toLowerCase();
            const max = parseInt(priceSlider?.value || '25000', 10);
            if (maxPriceDisplay){ maxPriceDisplay.textContent = `‚Çπ${Number(max).toLocaleString('en-IN')}`; }
            const filtered = hotelData.filter(h => {
                const base = Number(h.base_price_per_night || (h.rooms ? (h.rooms.NON_AC_RATE > 0 ? h.rooms.NON_AC_RATE : h.rooms.AC_RATE) : 0));
                const display = overridePriceByBackend(h.name, base);
                const okPrice = Number(display) <= max;
                const inName = h.name && h.name.toLowerCase().includes(term);
                const inLoc = (h.location && String(h.location).toLowerCase().includes(term)) || (h.address && h.address.toLowerCase().includes(term));
                const okTerm = !term || inName || inLoc;
                return okPrice && okTerm;
            });
            renderHotelsGrid(filtered);
        }

        
        document.addEventListener('DOMContentLoaded', function(){
            try { renderHotelsGrid(hotelData); } catch {}
            try { updateFilters(); } catch {}
        });

      

        window.getUserLocation = function() {
            locationDisplay.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Locating...`;
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        locationDisplay.innerHTML = `<i class="fas fa-check-circle" style="color: var(--primary-green);"></i> Location Found!`;
                        proximityFilter.style.display = 'block';
                        updateFilters(); 
                    },
                    (error) => {
                        userLocation = null;
                        locationDisplay.innerHTML = `<i class="fas fa-exclamation-triangle" style="color: var(--offer-badge-bg);"></i> Location denied or error.`;
                        proximityFilter.style.display = 'none';
                        updateFilters(); 
                        console.error("Geolocation Error: ", error);
                    },
                    { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                );
            } else {
                locationDisplay.innerHTML = `Geolocation not supported by this browser.`;
            }
        }

       

        function getActiveFilters() {
            const maxPrice = parseInt(priceSlider.value);
            const selectedRatings = Array.from(document.querySelectorAll('.rating-checkbox:checked'))
                                        .map(cb => parseFloat(cb.value));
            const selectedFacilitiesRaw = Array.from(document.querySelectorAll('.facility-checkbox:checked'))
                                            .map(cb => cb.value);
            
            const searchTerm = hotelSearchInput.value.toLowerCase().trim();
            const isNearbyChecked = selectedFacilitiesRaw.includes('nearby');
            const acRoomsChecked = selectedFacilitiesRaw.includes('acRooms');
            const nonAcRoomsChecked = selectedFacilitiesRaw.includes('nonAcRooms');

            const actualFacilities = selectedFacilitiesRaw.filter(f => !['nearby','acRooms','nonAcRooms'].includes(f));


            return { maxPrice, selectedRatings, actualFacilities, searchTerm, isNearbyChecked, acRoomsChecked, nonAcRoomsChecked };
        }

        function filterHotels(filters) {
            return hotelData.filter(hotel => {
                
                if (filters.searchTerm && !hotel.name.toLowerCase().includes(filters.searchTerm)) {
                    return false;
                }

            
                const lowestRate = Number(
                  hotel.base_price_per_night ?? (
                    hotel.rooms ? (hotel.rooms.NON_AC_RATE > 0 ? hotel.rooms.NON_AC_RATE : hotel.rooms.AC_RATE) : 0
                  )
                );
                if (lowestRate > filters.maxPrice) return false;

               
                if (filters.selectedRatings.length > 0) {
                    const matchesRating = filters.selectedRatings.some(minRating => hotel.rating >= minRating);
                    if (!matchesRating) return false;
                }

                if (filters.isNearbyChecked && userLocation && hotel.coords && hotel.coords.lat && hotel.coords.lng) {
                    const distance = getDistanceFromLatLonInKm(
                        userLocation.lat, userLocation.lng,
                        hotel.coords.lat, hotel.coords.lng
                    );
                    if (distance > NEARBY_RADIUS_KM) return false;
                }

                if (filters.acRoomsChecked && !hotel.hasAc) return false;
                if (filters.nonAcRoomsChecked && !hotel.hasNonAc) return false;

               
                if (filters.actualFacilities.length > 0) {
                    const hasAllFacilities = filters.actualFacilities.every(facility => 
                        Array.isArray(hotel.facilities) && hotel.facilities.includes(facility)
                    );
                    if (!hasAllFacilities) return false;
                }

                return true;
            });
        }

        function renderHotels(filteredList) {
            cardGrid.innerHTML = '';
            if (filteredList.length === 0) {
                noResultsMessage.style.display = 'block';
                return;
            }
            noResultsMessage.style.display = 'none';

            filteredList.forEach(hotel => {
                cardGrid.appendChild(createHotelCard(hotel));
            });
        }

        window.updateFilters = function() {
            maxPriceDisplay.textContent = `‚Çπ${parseInt(priceSlider.value).toLocaleString('en-IN')}`;
            const filters = getActiveFilters();
            const filteredList = filterHotels(filters);
            renderHotels(filteredList);
        }

        window.clearFilters = function() {
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            priceSlider.value = priceSlider.max;
            hotelSearchInput.value = '';
            updateFilters();
        }

        function setupPriceUpdateListener() {

            const checkDBManager = () => {
                if (typeof dbManager !== 'undefined') {
                    dbManager.addListener((event, data) => {
                        console.log('Database event received:', event, data);
                        if (event === 'hotelPricesUpdated' || event === 'dataUpdated') {
                            updateHotelDataFromDatabase();
                            updateFilters();
                            showPriceUpdateNotification();
                        }
                    });
                } else {
                    setTimeout(checkDBManager, 100);
                }
            };
            checkDBManager();
        }

        function updateHotelDataFromDatabase() {
            if (typeof dbManager !== 'undefined') {
                const dbHotels = dbManager.getAllHotels();
                dbHotels.forEach(dbHotel => {
                    const localHotel = hotelData.find(h => h.id === dbHotel.id);
                    if (localHotel && dbHotel.pricing) {
                  
                        localHotel.rooms.AC_RATE = dbHotel.pricing.standard || dbHotel.pricing.deluxe || dbHotel.pricing.suite || 0;
                        localHotel.rooms.NON_AC_RATE = dbHotel.pricing.standard || 0;
                     
                        const card = document.getElementById(`card-${localHotel.id}`);
                        if (card) {
                            const priceElement = card.querySelector('.card_price');
                            if (priceElement) {
                                const displayPrice = localHotel.rooms.NON_AC_RATE > 0 ? localHotel.rooms.NON_AC_RATE : localHotel.rooms.AC_RATE;
                                priceElement.textContent = `‚Çπ${displayPrice.toLocaleString('en-IN')}`;
                            }
                        }
                    }
                });
            }
        }

        function showPriceUpdateNotification() {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background-color: #4CAF50;
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 10000;
                animation: slideInFromRight 0.3s ease-out;
                max-width: 300px;
            `;
            notification.innerHTML = `
                <i class="fas fa-sync-alt"></i> Hotel prices updated! Refresh to see latest rates.
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideInFromRight 0.3s ease-out reverse';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }
      
        const selectedHotel = (() => { try { return JSON.parse(sessionStorage.getItem('selectedHotel') || '{}'); } catch { return {}; } })();
        document.addEventListener('DOMContentLoaded', () => {
            if (selectedHotel && selectedHotel.name) {
                const nameEl = document.getElementById('hotel-name');
                const rateEl = document.getElementById('hotel-rate');
                if (nameEl) nameEl.textContent = selectedHotel.name;
                if (rateEl) rateEl.textContent = `‚Çπ${(selectedHotel.lowestRate||0).toLocaleString()}`;
            }
        });
        

        async function bookRoom(roomNumber, checkInDate, checkOutDate) {
            if (!api.token) {
                alert('Please login to make a booking');
                window.location.href = 'login.html';
                return;
            }
            
            try {
                const result = await bookingManager.createBooking(
                    selectedHotel.id,
                    roomNumber,
                    checkInDate,
                    checkOutDate
                );
                  alert('Booking successful! You can now order food.');
                window.location.href = 'book.html';
                
            } catch (error) {
                console.error('Booking failed:', error);
            }
        }
        
       
        function orderFood(bookingId) {
            orderManager.showFoodOrderModal(bookingId);
        }
    </script>
    <script src="js/api-client.js"></script>
    <script>
        
        (function(){
        
            if (typeof window.overridePriceByBackend !== 'function') {
                window.overridePriceByBackend = function(_name, price){ return price; };
            }

            const FACILITY_POOL = [
                
                'breakfast','lunch','dinner','veg','nonVeg',
                
                'wifi','gym','spa','swimmingPool','laundry','barLounge','cityCenter','beachFront','petFriendly','suite','resort','sunView'
            ];
            function assignFacilities(h){
                const id = Number(h.hotel_id || h.id || 0);
                const count = 6 + (id % 4); 
                const chosen = new Set(['breakfast','lunch','dinner','veg','nonVeg']);
                for (let i=0; i<count; i++){
                    const idx = (id * 7 + i * 13) % FACILITY_POOL.length;
                    chosen.add(FACILITY_POOL[idx]);
                }
                return Array.from(chosen);
            }
            window.createHotelCard = function(h){
                const card = document.createElement('div');
                card.className = 'hotel_card';
                const fallback = 'images/hotel-placeholder.svg';
                const imgUrl = h.image_url || h.image || fallback;
                card.innerHTML = `
                    <div class="card_image"><img src="${imgUrl}" alt="${h.name}" onerror="this.onerror=null;this.src='${fallback}';"></div>
                    <div class="card_info">
                        <div class="card_title"><h4>${h.name}</h4><span class="card_rating">‚≠ê ${h.rating || '4.2'}</span></div>
                        <div class="card_price_offer">
                            <span class="card_price">‚Çπ${Number(h.base_price_per_night || h.price || 0).toLocaleString('en-IN')}</span>
                            <span class="card_offer">Best rate</span>
                        </div>
                    </div>
                `;
                
                const imgEl = card.querySelector('img');
                if (imgEl) imgEl.addEventListener('click', (ev)=>{ ev.stopPropagation(); try { openHotelModal(h); } catch {} });
         
                card.addEventListener('click', ()=>{ try { openHotelModal(h); } catch {} });
                return card;
            }

            async function loadHotelsFromBackendSafe(){
                const grid = document.getElementById('hotel-card-grid');
                const emptyMsg = document.getElementById('no-results');
                if (!grid) return;
                try{
                    const resp = await api.getHotels();
                    const raw = Array.isArray(resp) ? resp : (resp && resp.data ? resp.data : []);
                    const list = raw.map(h => ({
                        ...h,
                        facilities: (h.facilities && h.facilities.length)
                          ? Array.from(new Set([ 'breakfast','lunch','dinner','veg','nonVeg', ...h.facilities ]))
                          : assignFacilities(h),
                        
                        hasAc: true,
                        hasNonAc: true
                    }));
                   
                    window.hotelData = list;
                    if (!list.length){
                        grid.innerHTML = '';
                        if (emptyMsg) emptyMsg.style.display = 'block';
                        return;
                    }
                   
                    try { updateFilters(); }
                    catch{
                        if (emptyMsg) emptyMsg.style.display = 'none';
                        grid.innerHTML = '';
                        list.forEach(h => grid.appendChild(createHotelCard(h)));
                    }
                }catch(e){
                    console.error('Failed to load hotels from backend', e);
                }
            }

            document.addEventListener('DOMContentLoaded', loadHotelsFromBackendSafe);
        })();
    </script>
    <script>
      
        window.addEventListener('storage', function(ev){
            if (ev.key === 'priceUpdate'){
                refreshHotelPricesFromBackend();
            }
        });
    </script>
    
    
    <style>
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 5px;
            color: white;
            z-index: 10000;
            animation: slideIn 0.3s ease-out;
        }
        .notification.success { background-color: #4CAF50; }
        .notification.error { background-color: #f44336; }
        .notification.info { background-color: #2196F3; }
        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        .modal {
            display: block;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 10px;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover { color: #000; }
        
        .food-item {
            border: 1px solid #eee;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
        }
        .quantity-controls {
            display: inline-block;
            margin-left: 10px;
        }
        .quantity-controls button {
            width: 30px;
            height: 30px;
            border: 1px solid #ddd;
            background-color: #f5f5f5;
            cursor: pointer;
        }
        .quantity-controls span {
            display: inline-block;
            width: 30px;
            text-align: center;
            margin: 0 5px;
        }
    
    </style>
    
</body>
</html>
